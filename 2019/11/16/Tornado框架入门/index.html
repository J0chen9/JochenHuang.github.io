<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Tornado框架入门 | RhubarbC的博客</title><meta name="description" content="关于Tornado框架的个人学习心得。因为在学习Tornado前已经学习了Django。所以在这里许多知识点我没有特别详细的说明并且会跟与django做对比去学习！"><meta name="keywords" content="python,Tornado,web框架,入门"><meta name="author" content="Rhubarb C"><meta name="copyright" content="Rhubarb C"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://yoursite.com/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Tornado框架入门"><meta name="twitter:description" content="关于Tornado框架的个人学习心得。因为在学习Tornado前已经学习了Django。所以在这里许多知识点我没有特别详细的说明并且会跟与django做对比去学习！"><meta name="twitter:image" content="http://yoursite.com/img/tornado_cover.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Tornado框架入门"><meta property="og:url" content="http://yoursite.com/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/"><meta property="og:site_name" content="RhubarbC的博客"><meta property="og:description" content="关于Tornado框架的个人学习心得。因为在学习Tornado前已经学习了Django。所以在这里许多知识点我没有特别详细的说明并且会跟与django做对比去学习！"><meta property="og:image" content="http://yoursite.com/img/tornado_cover.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="WebSocket" href="http://yoursite.com/2019/11/18/WebSocket/"><link rel="next" title="scrapy框架进阶" href="http://yoursite.com/2019/11/09/scrapy%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://deehuang.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: {"languages":{"author":"作者: Rhubarb C","link":"链接: http://yoursite.com/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/","source":"来源: RhubarbC的博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  copy_copyright_js: true
  
}</script></head><body><canvas class="fireworks"></canvas><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">RhubarbC的博客</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Tornado框架"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Tornado框架</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#基本操作"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">基本操作</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#快速上手"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">快速上手</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#路由系统"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">路由系统</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#模板"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">模板</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#实用功能"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">实用功能</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#静态文件"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">静态文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#csrf"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">csrf</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#拓展功能之自定义Session"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">拓展功能之自定义Session</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#结语"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">结语</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tornado框架"><span class="toc-number">1.</span> <span class="toc-text">Tornado框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本操作"><span class="toc-number">2.</span> <span class="toc-text">基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快速上手"><span class="toc-number">2.1.</span> <span class="toc-text">快速上手</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路由系统"><span class="toc-number">2.2.</span> <span class="toc-text">路由系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板"><span class="toc-number">2.3.</span> <span class="toc-text">模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实用功能"><span class="toc-number">3.</span> <span class="toc-text">实用功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#静态文件"><span class="toc-number">3.1.</span> <span class="toc-text">静态文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#csrf"><span class="toc-number">3.2.</span> <span class="toc-text">csrf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拓展功能之自定义Session"><span class="toc-number">4.</span> <span class="toc-text">拓展功能之自定义Session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结语"><span class="toc-number">5.</span> <span class="toc-text">结语</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/tornado_top.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Tornado框架入门</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-11-16<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-11-23</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/python/">python</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.8k</span><span class="post-meta__separator">|</span><span>阅读时长: 17 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="Tornado框架"><a href="#Tornado框架" class="headerlink" title="Tornado框架"></a>Tornado框架</h2><p>Tornado其实是一个十分轻量级的web服务器框架，组件十分的少，学习起来十分的轻松简单。因为tornado提供的开发功能并不强大，所以许多web开发中常用的功能组件都需要自己去写而不像django一样提供许多功能强大的组件直接供我们调用（如ORM、FROM表单验证和Session等等）。而Tornado最强大的一点是它的异步非阻塞功能！<br>所以本篇除了介绍它的基本操作外，还会自定义一些在web开发中常常需要用到的组件。而对于异步非阻塞的功能我在进阶篇中再去描述自己的一些愚见</p>
<p>安装：<code>pip install tornado</code></p>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>web服务器框架的基本操作简单说就是由<strong>路由系统</strong>接收用户发来的请求，并把请求转发给<strong>视图函数</strong>（C）处理，在视图处理过程中可能会涉及调用<strong>数据库操作</strong>（M），然后由视图函数交给<strong>模板引擎</strong>（V）渲染最后返回给用户。这就是web应用非常流行的MVC设计模式。学习tornado我们也是需要从这几个功能入手学习!</p>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><p>先简单的快速上手Tornado的使用，使用Tornado大致上就是执行处理以下这些事情：</p>
<ol>
<li>第一步：执行脚本，监听 8888 端口</li>
<li>第二步：浏览器客户端访问 /index  –&gt;  <a href="http://127.0.0.1:8888/index" target="_blank" rel="noopener">http://127.0.0.1:8888/index</a></li>
<li>第三步：服务器接受请求，并交由对应的类处理该请求</li>
<li>第四步：类接受到请求之后，根据请求方式（post / get / delete …）的不同调用并执行相应的方法</li>
<li>第五步：方法返回值的字符串内容发送浏览器</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span> <span class="comment"># 视图类</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"Hello, world"</span>) <span class="comment">#相当于diango的return Httpresponse,即返回响应</span></span><br><span class="line">        <span class="comment">#self.render('模板名') #去指定的模板路径去读取模板返回给前端</span></span><br><span class="line">        <span class="comment">#self.redirect('URI') #跳转</span></span><br><span class="line"></span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"template_path"</span>:<span class="string">'views'</span>,</span><br><span class="line">&#125; <span class="comment"># 配置模板的路径（默认从当前执行文件目录去找，但是我们一般把模板放在views目录中）</span></span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/index"</span>, MainHandler),  <span class="comment"># 路由映射（url--&gt;某个类）</span></span><br><span class="line">],**settings) <span class="comment">#把配置文件放到里面  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    application.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start() <span class="comment"># 把socket启动起来，监听请求</span></span><br></pre></td></tr></table></figure>

<p>如果我们把所有的东西都写在一个.py文件中，业务量大的话就显得十分杂乱，所以我们可以灵性的把功能分到不同的目录中去！</p>
<p><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/1.jpg" class="lozad"></p>
<p>每个目录放不同的py文件：</p>
<ul>
<li>controllers负责业务处理，放视图类的.py</li>
<li>models负责数据库操作，放操作数据库.py</li>
<li>views负责放我们的模板（一般都是HTML文件，就是我们django的template）</li>
</ul>
<h3 id="路由系统"><a href="#路由系统" class="headerlink" title="路由系统"></a>路由系统</h3><p>路由系统其实就是 url 和”类“的对应关系，这里不同于其他框架，其他很多框架均是 url对应函数，Tornado中每个url对应的是一个类。 这个类就是视图，在MVC中也叫<strong>控制器</strong>，它是负责处理业务的模块！</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line">  </span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">路由系统：</span></span><br><span class="line"><span class="string">	url --&gt; 类 （根据method执行不同的方法）</span></span><br><span class="line"><span class="string">"""</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.write(<span class="string">"Hello, world"</span>)</span><br><span class="line">        <span class="comment">#self.render('模板名') #去指定的模板路径去读取模板返回给前端</span></span><br><span class="line">        <span class="comment">#self.redirect('URI') #跳转</span></span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="comment">#登陆功能控制器（视图）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args,**kwagrs)</span>:</span></span><br><span class="line">        <span class="comment"># get请求执行该方法</span></span><br><span class="line">        self.render(<span class="string">'login.html'</span>,msg=<span class="string">''</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># post请求执行该方法</span></span><br><span class="line">        username = self.get_agrument(<span class="string">'user'</span>) <span class="comment">#get和post里面都去取</span></span><br><span class="line">        password = self.get_argument(<span class="string">'pwd'</span>)</span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">"root"</span> <span class="keyword">and</span> password == <span class="string">'123'</span>:</span><br><span class="line">            self.set_cookie(<span class="string">'is_login'</span>,<span class="string">'Ture'</span>) <span class="comment">#设置cookie</span></span><br><span class="line">            self.redireact(<span class="string">'https://deehuang.github.io/'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 渲染模板并把msg传到模板中（可以传字典）</span></span><br><span class="line">            self.render(<span class="string">'login.html'</span>,msg=<span class="string">'用户名或密码错误'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="comment">#主页功能控制器（视图）</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,*args,**kwargs)</span>:</span></span><br><span class="line">        login_staus = self.get_cookie(<span class="string">'is_login'</span>) <span class="comment">#获取cookie</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> login_staus:</span><br><span class="line">            self.redirect(<span class="string">'/login'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="comment">#如果不return函数会继续往下执行</span></span><br><span class="line">        self.write(<span class="string">'欢迎登陆'</span>)</span><br><span class="line">  </span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/index"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">    (<span class="string">r"/home"</span>, HomeHandler),</span><br><span class="line">]) </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    application.listen(<span class="number">80</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>

<p>请求到视图类中会根据请求方式去执行不同的类方法，例如post请求去执行的就是post方法（注意：类中的方法是小写的）</p>
<p>取请求的内容一般会用<code>self.get_argument()</code>方法。它是<em>get</em>和<em>post</em>方式都去取数据<br>如果要单独取get请求传来的数据可以使用<code>self.get_query_argument()</code><br>如果要单独取post请求传来的数据可以使用<code>self.get_body_argument()</code><br>如果要取全部的键值对只需要在使用<code>self.get_arguments()</code>即可（同适用于get和post方式取值）<br>如果要取文件内容可以使用<code>self.request.files[&#39;文件名&#39;]</code></p>
<p>其实用户请求的所有信息都封装在了控制器对象中的reques对象（<code>self.request</code>）中，上面的<em>get_argument</em>等等方法内部其实都是去request中去取值！</p>
<p>总结控制器中常用的请求相关的方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""控制器:"""</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">			self.render() <span class="comment">#渲染模板，返回模板响应</span></span><br><span class="line">			self.write() <span class="comment">#返回响应</span></span><br><span class="line">			self.redirect() <span class="comment">#跳转</span></span><br><span class="line">			</span><br><span class="line">			self.get_argument() <span class="comment">#取请求内容（get&amp;post都取）</span></span><br><span class="line">			self.get_arguments()</span><br><span class="line">			self.get_cookie() <span class="comment">#获取cookie</span></span><br><span class="line">			self.set_cookie() <span class="comment">#设置cookie</span></span><br><span class="line">			self.get_secure_cookie() <span class="comment">#获取加密的cookie(依赖配置文件)</span></span><br><span class="line">			self.set_secure_cookie() <span class="comment">#设置加密的cookie(依赖配置文件)</span></span><br><span class="line">			</span><br><span class="line">			self.request.files[<span class="string">'filename'</span>] <span class="comment">#获取上传的文件</span></span><br><span class="line">			self._headers <span class="comment">#获取请求头信息</span></span><br><span class="line">					</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""取文件内容的操作："""</span></span><br><span class="line">   		file_metas = self.request.files[<span class="string">"fff"</span>] <span class="comment">#拿到的是一个文件列表（因前端可能传多个文件）</span></span><br><span class="line">        <span class="comment"># print(file_metas)</span></span><br><span class="line">        <span class="keyword">for</span> meta <span class="keyword">in</span> file_metas:  <span class="comment">#遍历每个文件</span></span><br><span class="line">            file_name = meta[<span class="string">'filename'</span>] <span class="comment">#拿到文件名</span></span><br><span class="line">            <span class="keyword">with</span> open(file_name,<span class="string">'wb'</span>) <span class="keyword">as</span> up:</span><br><span class="line">                up.write(meta[<span class="string">'body'</span>]) <span class="comment">#meta['body']拿到文件内容</span></span><br></pre></td></tr></table></figure>

<p>补充：加密的cookie(依赖配置文件)</p>
<ol>
<li>设置配置文件，需要添加一个随机字符串密钥（用来给cookie安全加密）<br><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/2.jpg" class="lozad"></li>
<li>设置cookie的时候使用<code>self.set_secure_cookie()</code></li>
<li>取cookie的时候使用<code>self.get_secure_cookie()</code></li>
</ol>
<p>实际上对于加密cookie内部实现的本质是：</p>
<p>写cookie过程：</p>
<ul>
<li>将值进行base64加密</li>
<li>对除值以外的内容进行签名，哈希算法（无法逆向解析）</li>
<li>拼接 签名 + 加密值</li>
</ul>
<p>读cookie过程：</p>
<ul>
<li>读取 签名 + 加密值</li>
<li>对签名进行验证</li>
<li>base64解密，获取值内容</li>
</ul>
<p>如果还想获取更多请求的信息可以遵循这样的寻找顺序：<br>控制器对象（可以去父类<code>tornado.web.RequestHandler</code>里面去找）<br>控制器对象中找不到就去<code>self.request</code>去找（它的类型是<code>tornado.httputil.HTTPSeverRequest</code>）<br><em>PS:寻找信息主要去它们的构造方法<code>__init__()</code>里面去找就行了</em></p>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>请求首先到路由系统，根据路由匹配分发到不同的控制器中去处理业务。控制器处理完业务后一般返回三个结果：<br><code>redirect()</code>、<code>write()</code>和<code>render()</code><br>redirect就是跳转，write()就是直接写返回给浏览器。两个功能都十分简单明了<br>而render较为复杂因为它做的就是模板引擎的渲染！就是这里要介绍的模板！</p>
<p> Tornao中的模板语言和django中类似，模板引擎将模板文件载入内存，然后将<strong>数据嵌入其中</strong>，最终获取到一个完整的字符串，再将字符串返回给请求者。 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Tornado 的模板支持“控制语句”和“表达语句”：</span><br><span class="line">控制语句是使用&#123;% 和 %&#125;包起来的 例如 &#123;% if len(items) &gt; 2 %&#125;。</span><br><span class="line">表达语句是使用&#123;&#123; 和 &#125;&#125;包起来的，例如 &#123;&#123; items[0] &#125;&#125;。</span><br><span class="line"></span><br><span class="line">控制语句和对应的Python语句的格式基本完全相同。我们支持 if、for、while和try，这些语句逻辑结束的位置需要用&#123;% end %&#125;做标记。还通过extends和block 语句实现了模板继承。这些在 [template模块](http://github.com/facebook/tornado/blob/master/tornado/template.py)的代码文档中有着详细的描述。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;&quot;&quot;Tornado常用的模板语法&quot;&quot;&quot;</span><br><span class="line">&#123;&#123; li[0] &#125;&#125; #索引取值</span><br><span class="line"></span><br><span class="line">&#123;% for i in range(10) %&#125;  &#123;% end %&#125;  #循环语句</span><br><span class="line"></span><br><span class="line">#继承</span><br><span class="line">&#123;% block CSS %&#125;&#123;% end %&#125; #母版</span><br><span class="line">&#123;% extends &apos;母版名&apos;&#125;  &#123;% block CSS %&#125;&#123;% end %&#125; #子版 需要先在文件头使用extends标签引入母版</span><br><span class="line"></span><br><span class="line">在模板中默认提供了一些函数、字段、类以供模板使用：</span><br><span class="line">escape: tornado.escape.xhtml_escape 的別名</span><br><span class="line">xhtml_escape: tornado.escape.xhtml_escape 的別名</span><br><span class="line">url_escape: tornado.escape.url_escape 的別名</span><br><span class="line">json_encode: tornado.escape.json_encode 的別名</span><br><span class="line">squeeze: tornado.escape.squeeze 的別名</span><br><span class="line">linkify: tornado.escape.linkify 的別名</span><br><span class="line">datetime: Python 的 datetime 模组</span><br><span class="line">handler: 当前的 RequestHandler 对象</span><br><span class="line">request: handler.request 的別名</span><br><span class="line">current_user: handler.current_user 的別名</span><br><span class="line">locale: handler.locale 的別名</span><br><span class="line">_: handler.locale.translate 的別名</span><br><span class="line">static_url: for handler.static_url 的別名</span><br><span class="line">xsrf_form_html: handler.xsrf_form_html 的別名</span><br><span class="line"></span><br><span class="line">PS:Tornado的循环控制语句等都统一以&#123;% end %&#125;标签结尾，与django不太一样</span><br></pre></td></tr></table></figure>

<p>模板语言还支持自定制拓展方法和类，它是通过<em>UIMethod</em>和<em>UIModule</em>这两个组件去实现的（ 这两个组件类似于Django的simple_tag ）。<br>其实通过UIMethod定制方法已经能实现所有的我们想生成的内容了，那么UIModule定制类存在的意义是什么呢？UIModule除了和UIMethod一样可以帮我们生成内容还可以帮我们添加CSS，JS。</p>
<p>下面来看下它们的实现方式：</p>
<ol>
<li><p>定义：</p>
<ul>
<li><p>定制方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#模块名为uimethods.py</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tab</span><span class="params">(request)</span>:</span> </span><br><span class="line">	<span class="comment"># 默认会传入HTTPSeverRequest 即默认将请求的信息传过来了</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'UIMethod'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定制类：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""模块名为uimodules"""</span></span><br><span class="line"><span class="keyword">from</span> tornado.web <span class="keyword">import</span> UIModule</span><br><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> escape <span class="comment">#转义模块</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">custom</span><span class="params">(UIModule)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">css_files</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment">#导入css文件,在页面使用链接式引入css文件</span></span><br><span class="line">		<span class="comment">#默认会从静态文件夹static中去找（静态文件需在settings配置）</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">'文件路径'</span></span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">embedded_css</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="comment">#嵌入CSS</span></span><br><span class="line">		<span class="comment">#在页面&lt;head&gt;自动加入&lt;style type='text/css'&gt; 并把返回结果写入其中</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">'.c1&#123;display:None&#125;'</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">javascript_files</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#导入js文件，页面生成&lt;script src='/static/xxx'&gt;</span></span><br><span class="line">		<span class="comment">#默认会从静态文件夹static中去找（静态文件需在settings配置）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"文件路径"</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">embedded_javascript</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#嵌入js</span></span><br><span class="line">        <span class="comment">#页面会生成&lt;script&gt;并把返回内容写到其中</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'js代码'</span></span><br><span class="line">		</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">    	<span class="comment">#模板直接调用类就会执行render方法</span></span><br><span class="line">        <span class="keyword">return</span> escape.xhtml_escape(<span class="string">'&lt;h1&gt;deehuang&lt;/h1&gt;'</span>) </span><br><span class="line">        <span class="comment">#把要传入前端的html字符串进行转义</span></span><br><span class="line">        <span class="comment">#使得后端渲染到模板的html字符串不能被浏览器渲染（xss防御机制）</span></span><br></pre></td></tr></table></figure>

<p>*Ps:UIMethod中如果return的是一个html标签，tornado内部会自动帮我们转义为字符串到浏览器显示而不是渲染该标签。如果我们想关掉自动转义功能需要在settings里面设置<code>autoescape:None</code>。但实际运用中不允许这样使用（会遭到xss攻击），所以我们只能在前端模板中使用raw标签告诉模板引擎这句是不转义的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% raw tab() %&#125;</span><br></pre></td></tr></table></figure>

<p>​    <em>而UIModules中是不会自动转义的，需要我们使用escape方法来对要传入前端的html字符串进行转义</em></p>
</li>
</ul>
</li>
<li><p>注册：在配置文件中settings中把定制的方法或类模块放进去，这样Tornado才找得到</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uimodules <span class="keyword">as</span> md</span><br><span class="line"><span class="keyword">import</span> uimethods <span class="keyword">as</span> mt</span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">'template_path'</span>: <span class="string">'template'</span>,</span><br><span class="line">    <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    <span class="string">'static_url_prefix'</span>: <span class="string">'/static/'</span>,</span><br><span class="line">    <span class="string">'ui_methods'</span>: mt,</span><br><span class="line">    <span class="string">'ui_modules'</span>: md,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/index"</span>, MainHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% module Custom(123) %&#125; # 定制的类</span><br><span class="line">&#123;&#123; tab() &#125;&#125; #定制的方法</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>拓展：模板引擎内部是怎么实现的？</p>
<p>对于模板语言的整个流程，其本质就是处理html文件内容将html文件内容转换成函数，然后为该函数提供全局变量环境（即：我们想要嵌套进html中的值和框架自带的值），再之后执行该函数从而获取到处理后的结果，再再之后则执行UI_Modules继续丰富返回结果，例如：添加js文件、添加js内容块、添加css文件、添加css内容块、在body内容第一行插入数据、在body内容最后一样插入数据，最终，通过soekct客户端对象将处理之后的返回结果（字符串）响应给请求用户。 </p>
<p><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/3.jpg" class="lozad"><br><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/4.jpg" class="lozad"></p>
<h2 id="实用功能"><a href="#实用功能" class="headerlink" title="实用功能"></a>实用功能</h2><h3 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h3><p> 对于静态文件，可以配置静态文件的目录和前端使用时的前缀 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">'template_path'</span>: <span class="string">'template'</span>,</span><br><span class="line">    <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    <span class="comment">#前端模板使用使的前缀 模板标签&#123;&#123; static_url('模块名') &#125;&#125;就会从/static/模块名去找</span></span><br><span class="line">    <span class="string">'static_url_prefix'</span>: <span class="string">'/static/'</span>, </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/index"</span>, MainHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>

<h3 id="csrf"><a href="#csrf" class="headerlink" title="csrf"></a>csrf</h3><p> Tornado中的跨站请求伪造和Django中的相似 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""设置配置文件"""</span></span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">"xsrf_cookies"</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/"</span>, MainHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">], **settings)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">""" 前端模板：在表单中使用 """</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/new_message"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">  &#123;&#123; xsrf_form_html() &#125;&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"message"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Post"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">""</span><span class="string">"前端模板 在ajax中使用：本质上就是去获取本地的cookie，携带cookie再来发送请求"</span><span class="string">""</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCookie</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> r = <span class="built_in">document</span>.cookie.match(<span class="string">"\\b"</span> + name + <span class="string">"=([^;]*)\\b"</span>);</span><br><span class="line">    <span class="keyword">return</span> r ? r[<span class="number">1</span>] : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.postJSON = <span class="function"><span class="keyword">function</span>(<span class="params">url, args, callback</span>) </span>&#123;</span><br><span class="line">    args._xsrf = getCookie(<span class="string">"_xsrf"</span>);</span><br><span class="line">    $.ajax(&#123;<span class="attr">url</span>: url, <span class="attr">data</span>: $.param(args), <span class="attr">dataType</span>: <span class="string">"text"</span>, <span class="attr">type</span>: <span class="string">"POST"</span>,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        callback(<span class="built_in">eval</span>(<span class="string">"("</span> + response + <span class="string">")"</span>));</span><br><span class="line">    &#125;&#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="拓展功能之自定义Session"><a href="#拓展功能之自定义Session" class="headerlink" title="拓展功能之自定义Session"></a>拓展功能之自定义Session</h2><p>在这里我们希望自定制一个session组件来方便我们在tornado的控制器中处理业务的时候可以实现对session的快速调用存储。</p>
<ol>
<li><p>知识储备：</p>
<ul>
<li><p>关于多继承：<br>super是自动按照顺序查找（深度优先）<br>如果不想按顺序查找可以使用<code>类名.方法名(self)</code>的方式去指定执行某个父类的属性方法<br><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/5.jpg" class="lozad"><br>有个老生常谈的问题self是谁？self永远是调用方法的对象</p>
</li>
<li><p>关于面向对象：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">print</span>  <span class="string">'__getitem__'</span>,key</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'__setitem__'</span>,key,value</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">'__delitem__'</span>,key</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">obj = Foo()</span><br><span class="line">result = obj[<span class="string">'k1'</span>] <span class="comment"># 对象['key']会触发__getitem__</span></span><br><span class="line"><span class="comment">#obj['k2'] = 'deehuang' # 对象['key']='xxx'会触发__setitem__</span></span><br><span class="line"><span class="comment">#del obj['k1'] #触发__delitem__</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Tornado控制器中的钩子（Hook）<br>在控制器中，提供了一个我们可以自定义拓展操作的钩子函数 <em>initialize</em>。请求过来后首先会实例化我们的控制器对象，实例化的时候就会执行钩子函数initialize方法（因为在实例化过程执行构造方法的最后调用了钩子）。最后再去根据请求方式执行相应的函数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.A = <span class="number">123</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.A)</span><br><span class="line">        self.write(<span class="string">'Hello world'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""结合多继承的知识使用,完成对控制器拓展操作"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initalize</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.A = <span class="number">123</span></span><br><span class="line">        super(Foo,self).initialize() <span class="comment">#使用super顺序调用其他父类不影响后面类的定制方法</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainHandler</span><span class="params">(Foo)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.A)</span><br><span class="line">        self.write(<span class="string">'Hello world'</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>session的实现机制：</p>
<ul>
<li><p>生成随机字符串</p>
</li>
<li><p>写入用户Cookie</p>
</li>
<li><p>后台存储</p>
</li>
<li><p>在控制器中<code>self.session[&#39;xx&#39;]</code>实现session机制，就需要用到上面说到的知识储备了！</p>
<p><img alt data-src="/2019/11/16/Tornado%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/6.jpg" class="lozad"></p>
</li>
</ul>
</li>
</ol>
<ol start="3">
<li><p>session框架</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.ioloop</span><br><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os, time</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">session格式:</span></span><br><span class="line"><span class="string">#一个随机字符串代表的是一个用户</span></span><br><span class="line"><span class="string">#每个用户都对应一个值，它是一个字典用以存储用户的信息（在这里叫做用户）</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">'每个用户都有一个随机字符串': &#123;'uesr':deehuang,is_login:ture&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    session可以储存在内存，数据库，硬盘或缓存中，使用构造配置文件来让用户可以指定存储方式</span></span><br><span class="line"><span class="string">    Cache表示将session保存在内存中</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.session_container = &#123;&#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__contanins__</span><span class="params">(self,item)</span>:</span></span><br><span class="line">        <span class="string">"""使用 x in obj 语法会触发该函数，用来判断sessionid是否在该容器里面"""</span></span><br><span class="line">        <span class="keyword">return</span> item <span class="keyword">in</span> self.session_container</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initial</span><span class="params">(self,random_str)</span>:</span></span><br><span class="line">        <span class="string">"""用来给每个用户的sessionid 创建字典"""</span></span><br><span class="line">        self.session_container[random_str] = &#123;&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        存储在内存的话不需要用到open</span></span><br><span class="line"><span class="string">        这里只是作规范，因为如果储存在文件或者数据库的话都要涉及打开或者连接操作   </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        存储在内存的话不需要用到close</span></span><br><span class="line"><span class="string">        这里只是作规范，因为如果储存在文件或者数据库的话都要涉及打开或者连接操作   </span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,random_str,key)</span>:</span></span><br><span class="line">        <span class="comment">#获取用户字典信息 </span></span><br><span class="line">        <span class="comment">#避免取值的时候字典中没有匹配的键会报错，使用get方法去字典取值（不存在返回None）</span></span><br><span class="line">        self.session_container[random_str].get(key)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self,key,random_str,value)</span>:</span></span><br><span class="line">        <span class="comment">#设置用户信息</span></span><br><span class="line">         self.session_container[random_str][key] = value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,random_str,key)</span>:</span></span><br><span class="line">        <span class="comment">#删除用户字典中的某一键值对</span></span><br><span class="line">		<span class="keyword">del</span> self.session_container[random_str][key]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self,random_str)</span>:</span></span><br><span class="line">        <span class="comment"># 清除用户的session字典</span></span><br><span class="line">        <span class="keyword">del</span> self.session_container[random_str]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""session存储在文件，方法同上规范化"""</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""session存储在缓存，方法同上规范化"""</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataBase</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""session存储在数据库，方法同上规范化"""</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">P = Cache  <span class="comment">#配置文件，表示的是session的存储方式</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span><span class="params">(object)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, handler)</span>:</span></span><br><span class="line">        <span class="comment"># 从钩子函数传过来的控制器对象中有设置和获取cookie的方法</span></span><br><span class="line">        self.handler = handler</span><br><span class="line">        self.random_str = <span class="literal">None</span></span><br><span class="line">        self.ppp = P()  <span class="comment"># 储存session的容器</span></span><br><span class="line">        self.ppp.open()</span><br><span class="line">  		</span><br><span class="line">        <span class="comment">#去用户请求传来的cookie中获取sessionid</span></span><br><span class="line">        client_random_str = self.handler.get_cookie(<span class="string">'session_id'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> client_random_str:</span><br><span class="line">            <span class="comment">#如果没有sessionid：表示是新用户 则给它创建一个随机字符串（sessionid）</span></span><br><span class="line">    		self.random_str = self.create_random_str()</span><br><span class="line">            self.ppp.initial(self.random_str) <span class="comment">#创建用户字典</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#有sessionid去session中去匹配用户然后将信息写入用户字典中</span></span><br><span class="line">            <span class="comment">#因为id有可能是用户伪造的并非是我们sever生成所以要在这里做一些判断：</span></span><br><span class="line">            <span class="keyword">if</span> client_random_str <span class="keyword">in</span> self.ppp: </span><br><span class="line">                <span class="string">"""老用户"""</span></span><br><span class="line">            	self.random_str = client_random_str</span><br><span class="line">             <span class="keyword">else</span>:</span><br><span class="line">                <span class="string">"""非法用户（伪造s_id）"""</span></span><br><span class="line">                self.random_str = self.create_random_str()</span><br><span class="line">                self.ppp.initial(self.random_str) <span class="comment">#创建用户字典</span></span><br><span class="line">       	<span class="comment">#把s_id设置到cookie中并设置超时时间(参数expries=当前时间+失效时间，单位是s)</span></span><br><span class="line">        <span class="comment">#如果sessionid存在该方法内部不会重复去设置，只是会更新失效时间而已！</span></span><br><span class="line">        ctime = time.time() <span class="comment">#获取当前时间</span></span><br><span class="line">        self.handler.set_cookie(<span class="string">'session_id'</span>,self.random_str,expires=ctime+<span class="number">1800</span>)      	 self.ppp.close()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_random_str</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""生成随机字符串"""</span></span><br><span class="line">        v = str(time.time())</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        m.update(bytes(v,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">        <span class="keyword">return</span> m.hexdigest()</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="string">"""获取session中用户信息"""</span></span><br><span class="line">        self.ppp.open()</span><br><span class="line">        v =  self.ppp.get(self.random_str,key)</span><br><span class="line">        self.ppp.close()</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="string">"""my_session['key']=value会触发该方法并将key和value传入"""</span></span><br><span class="line">        <span class="comment">#后台存储---&gt;设置用户session字典</span></span><br><span class="line">        self.ppp.open()</span><br><span class="line">        self.ppp.set(self.random_str,key,value)</span><br><span class="line">        self.ppp.close()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        self.ppp.open()</span><br><span class="line">        <span class="keyword">del</span> self.ppp.delete(self.random_str,key) </span><br><span class="line">        self.ppp.close()</span><br><span class="line">  </span><br><span class="line">  	<span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""清空当前用户的session"""</span></span><br><span class="line">        self.ppp.open()</span><br><span class="line">        self.ppp.clear(random_str)</span><br><span class="line">        self.ppp.close()</span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></span><br><span class="line">  	<span class="string">"""拓展控制器功能"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#self是MianHandler对象</span></span><br><span class="line">        <span class="comment"># my_session['k1']访问 __getitem__ 方法</span></span><br><span class="line">        self.my_session = Session(self) <span class="comment">#把对象传到Session中</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        user = self.my_session[<span class="string">'user'</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            <span class="comment"># 用户字典中没有user值，表示没有登陆</span></span><br><span class="line">            self.redirect(<span class="string">'http://deehuang.github.io'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.write(user)</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.my_session[<span class="string">'user'</span>] = <span class="string">'root'</span></span><br><span class="line">        self.redirect(<span class="string">'/home'</span>)</span><br><span class="line">        </span><br><span class="line">settings = &#123;</span><br><span class="line">    <span class="string">'template_path'</span>: <span class="string">'template'</span>,</span><br><span class="line">    <span class="string">'static_path'</span>: <span class="string">'static'</span>,</span><br><span class="line">    <span class="string">'static_url_prefix'</span>: <span class="string">'/static/'</span>,</span><br><span class="line">    <span class="string">'cookie_secret'</span>: <span class="string">'woshisuijimiyao'</span>,</span><br><span class="line">    <span class="string">'login_url'</span>: <span class="string">'/login'</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">application = tornado.web.Application([</span><br><span class="line">    (<span class="string">r"/home"</span>, HomeHandler),</span><br><span class="line">    (<span class="string">r"/login"</span>, LoginHandler),</span><br><span class="line">], **settings)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    application.listen(<span class="number">8888</span>)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br></pre></td></tr></table></figure>

<p>session框架的原理是不分语言不分web框架的，每个框架内部都是这样去实现的</p>
</li>
</ol>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>以上是个人学习之路，如有误，欢迎指正！<a href="https://www.cnblogs.com/wupeiqi/articles/5341480.html" target="_blank" rel="noopener">参考文献</a></p>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/python/">python    </a><a class="post-meta__tags" href="/tags/Tornado/">Tornado    </a><a class="post-meta__tags" href="/tags/web%E6%A1%86%E6%9E%B6/">web框架    </a><a class="post-meta__tags" href="/tags/%E5%85%A5%E9%97%A8/">入门    </a></div><div class="post_share"><div class="social-share" data-image="/img/tornado_cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/11/18/WebSocket/"><img class="prev_cover lozad" data-src="/img/cover_default3.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>WebSocket</span></div></a></div><div class="next-post pull-right"><a href="/2019/11/09/scrapy%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"><img class="next_cover lozad" data-src="/img/scrapy入门_cover.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>scrapy框架进阶</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/19/Tornado框架进阶/" title="Tornado框架进阶"><img class="relatedPosts_cover lozad"data-src="/img/tornado_cover.jpg"><div class="relatedPosts_title">Tornado框架进阶</div></a></div><div class="relatedPosts_item"><a href="/2019/11/18/WebSocket/" title="WebSocket"><img class="relatedPosts_cover lozad"data-src="/img/cover_default3.jpg"><div class="relatedPosts_title">WebSocket</div></a></div><div class="relatedPosts_item"><a href="/2019/11/21/Celery/" title="Celery"><img class="relatedPosts_cover lozad"data-src="/img/cover_default3.jpg"><div class="relatedPosts_title">Celery</div></a></div><div class="relatedPosts_item"><a href="/2019/11/21/缓存数据库Redis/" title="缓存数据库Redis"><img class="relatedPosts_cover lozad"data-src="/img/cover_default3.jpg"><div class="relatedPosts_title">缓存数据库Redis</div></a></div><div class="relatedPosts_item"><a href="/2019/10/30/Scrapy框架/" title="Scrapy框架入门"><img class="relatedPosts_cover lozad"data-src="/img/scrapy入门_cover.jpg"><div class="relatedPosts_title">Scrapy框架入门</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80NzI1MC8yMzc1MA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div></div><footer style="background-image: url(/img/tornado_top.jpg)"><div id="footer"><div class="copyright">&copy;2019 - 2020 By Rhubarb C</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script color="0,0,255" opacity="0.7" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/js/canvas-nest.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script></body></html>